<style>
  .zs-calc-size {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px 20px;
  }

  .zs-calc-size__card {
    background: linear-gradient(135deg, #ff7536 0%, #ff5000 100%);
    border-radius: 16px;
    padding: 30px;
    max-width: 600px;
    width: 100%;
    box-shadow: 0 10px 40px rgba(255, 107, 53, 0.3);
  }

  /* ================================
     Postcode Section
================================ */
  .zs-calc-size__section {
    margin-bottom: 25px;
  }

  .zs-calc-size__section:last-child {
    margin-bottom: 0;
  }

  .zs-calc-size__title {
    font-size: 20px;
    font-weight: 600;
    color: #fff;
    margin: 0 0 15px 0;
  }

  .zs-calc-size__inputs {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }

  .zs-calc-size__input {
    width: 110px;
    height: 48px !important;
    padding: 0 15px;
    border: none !important;
    border-radius: 8px;
    font-size: 18px;
    background: #fff !important;
    color: #333 !important;
    outline: none !important;
    box-shadow: none !important;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
  }

  .zs-calc-size__input:hover,
  .zs-calc-size__input:focus,
  .zs-calc-size__input:active {
    border: none !important;
    outline: none !important;
    box-shadow: none !important;
    background: #fff !important;
  }

  .zs-calc-size__input::placeholder {
    color: #999 !important;
    opacity: 1;
  }

  .zs-calc-size__address {
    color: rgba(255, 255, 255, 0.8);
    font-size: 14px;
    margin: 10px 0 0 0;
    font-style: italic;
  }

  /* ================================
     Size Calculator Section
================================ */
  .zs-calc-size__size-inputs {
    display: flex;
    gap: 10px;
    align-items: flex-start;
  }

  .zs-calc-size__input-group {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }

  .zs-calc-size__input-group input {
    order: 1;
  }

  .zs-calc-size__input-group label {
    order: 2;
    margin-top: 6px;
  }

  .zs-calc-size__input--number {
    width: 100px;
    height: 48px !important;
    padding: 0 16px;
    border: none !important;
    border-radius: 8px;
    font-size: 24px !important;
    font-weight: 500 !important;
    background: #fff !important;
    color: #1a1c22 !important;
    text-align: left;
    outline: none !important;
    box-shadow: none !important;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
  }

  .zs-calc-size__input--number::-webkit-inner-spin-button,
  .zs-calc-size__input--number::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .zs-calc-size__input--number {
    -moz-appearance: textfield;
  }

  .zs-calc-size__label {
    display: block;
    font-weight: 400;
    font-size: 14px;
    color: #fff;
    opacity: 0.7;
  }

  .zs-calc-size__result {
    color: #fff;
    font-size: 28px;
    font-weight: 700;
    display: flex;
    align-items: center;
    margin-left: 15px;
  }

  .zs-calc-size__result sup {
    font-size: 14px;
    vertical-align: super;
  }

  /* ================================
     Value Appreciation Section
================================ */
  .zs-calc-size__divider {
    height: 1px;
    background: rgba(255, 255, 255, 0.3);
    margin: 25px 0;
  }

  .zs-calc-size__value {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .zs-calc-size__value-label {
    color: #fff;
    font-size: 20px;
    font-weight: 500;
  }

  .zs-calc-size__value-amount {
    color: #fff;
    font-size: 48px;
    font-weight: 700;
    line-height: 1;
  }

  .zs-calc-size__value-amount sup {
    font-size: 16px;
    background: #fff;
    color: #ff6b35;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-left: 5px;
    vertical-align: super;
    font-weight: 600;
  }

  /* ================================
     Responsive Styles
================================ */
  @media (max-width: 576px) {
    .zs-calc-size__card {
      padding: 20px;
    }

    .zs-calc-size__inputs {
      flex-wrap: wrap;
    }

    .zs-calc-size__input {
      width: calc(33.33% - 7px);
      min-width: 80px;
    }

    .zs-calc-size__size-inputs {
      flex-wrap: wrap;
    }

    .zs-calc-size__input--number {
      width: 80px;
    }

    .zs-calc-size__result {
      width: 100%;
      margin-left: 0;
      margin-top: 15px;
      justify-content: center;
    }

    .zs-calc-size__value {
      flex-wrap: wrap;
      justify-content: center;
      text-align: center;
    }

    .zs-calc-size__value-amount {
      font-size: 42px;
    }
  }
</style>

<section class="zs-calc-size" id="zs-calc-size">
  <div class="zs-calc-size__card">
    
    {% comment %} Postcode Section {% endcomment %}
    <div class="zs-calc-size__section">
      <h3 class="zs-calc-size__title">{{ section.settings.postcode_title | default: 'Postcode en huisnummer' }}</h3>
      <div class="zs-calc-size__inputs">
        <input 
          type="text" 
          id="zs-postcode" 
          name="postcode"
          placeholder="{{ section.settings.postcode_placeholder | default: 'Postc.' }}" 
          class="zs-calc-size__input"
          maxlength="7"
        >
        <input 
          type="text" 
          id="zs-housenumber" 
          name="housenumber"
          placeholder="{{ section.settings.housenumber_placeholder | default: 'Huisnr.' }}" 
          class="zs-calc-size__input"
        >
        <input 
          type="text" 
          id="zs-addition" 
          name="addition"
          placeholder="{{ section.settings.addition_placeholder | default: 'Toev.' }}" 
          class="zs-calc-size__input"
        >
      </div>
      <p class="zs-calc-size__address" id="zs-address">Straatnaam, Plaats</p>
    </div>

    {% comment %} Size Calculator Section {% endcomment %}
    <div class="zs-calc-size__section">
      <h3 class="zs-calc-size__title">{{ section.settings.size_title | default: 'Grootte van je aanbouw' }}</h3>
      <div class="zs-calc-size__size-inputs">
        <div class="zs-calc-size__input-group">
          <input 
            type="number" 
            id="zs-depth" 
            name="depth"
            value="{{ section.settings.default_depth | default: 400 }}"
            min="{{ section.settings.min_depth | default: 150 }}"
            max="{{ section.settings.max_depth | default: 400 }}"
            class="zs-calc-size__input--number"
            inputmode="numeric"
            pattern="[0-9]*"
          >
          <label for="zs-depth" class="zs-calc-size__label">{{ section.settings.depth_label | default: 'Diepte (cm)' }}</label>
        </div>
        <div class="zs-calc-size__input-group">
          <input 
            type="number" 
            id="zs-length" 
            name="length"
            value="{{ section.settings.default_length | default: 600 }}"
            min="{{ section.settings.min_length | default: 200 }}"
            max="{{ section.settings.max_length | default: 1500 }}"
            class="zs-calc-size__input--number"
            inputmode="numeric"
            pattern="[0-9]*"
          >
          <label for="zs-length" class="zs-calc-size__label">{{ section.settings.length_label | default: 'Lengte (cm)' }}</label>
        </div>
        <div class="zs-calc-size__result">
          <span id="zs-size-result">24</span>m<sup>2</sup>
        </div>
      </div>
    </div>

    {% comment %} Value Appreciation Section {% endcomment %}
    <div class="zs-calc-size__divider"></div>
    <div class="zs-calc-size__value">
      <span class="zs-calc-size__value-label">{{ section.settings.value_label | default: 'Meerwaarde:' }}</span>
      <span class="zs-calc-size__value-amount" id="zs-value-result">€0<sup>?</sup></span>
    </div>

  </div>
</section>

<script>
  (function() {
    'use strict';

    // ================================
    // DOM Elements
    // ================================
    const depthInput = document.getElementById('zs-depth');
    const lengthInput = document.getElementById('zs-length');
    const sizeResult = document.getElementById('zs-size-result');
    const postcodeInput = document.getElementById('zs-postcode');
    const housenumberInput = document.getElementById('zs-housenumber');
    const additionInput = document.getElementById('zs-addition');
    const addressDisplay = document.getElementById('zs-address');
    const valueDisplay = document.getElementById('zs-value-result');

    // Debounce timer for API calls
    let debounceTimer = null;

    // ================================
    // Province-based m² pricing (Calibrated to match main deprefabriek.nl)
    // Reference: Gelderland (7207RS) = €3,500/m² → €31,500 for 9m²
    // ================================
    const provinceM2Prices = {
      'Noord-Holland': 4750,
      'Zuid-Holland': 4300,
      'Utrecht': 4500,
      'Noord-Brabant': 3600,
      'Gelderland': 3500,
      'Limburg': 2950,
      'Overijssel': 3150,
      'Flevoland': 3400,
      'Drenthe': 2700,
      'Groningen': 2825,
      'Friesland': 2600,
      'Zeeland': 3050
    };
    const defaultM2Price = 3400;

    // Store the province from API response
    let currentProvince = null;

    // ================================
    // Size Calculator
    // ================================
    function calculateSize() {
      const depth = parseFloat(depthInput?.value) || 0;
      const length = parseFloat(lengthInput?.value) || 0;
      const sizeM2 = (depth * length) / 10000; // Convert cm² to m²
      if (sizeResult) {
        sizeResult.textContent = Math.round(sizeM2);
      }
      // Recalculate value when size changes
      calculateValueFromCurrentData();
    }

    // ================================
    // Province Detection from Postcode (Calibrated to match deprefabriek.nl)
    // ================================
    function getProvinceFromPostcode(postcode) {
      if (!postcode || postcode.length < 4) return null;
      
      const postcodeNum = parseInt(postcode.substring(0, 4), 10);
      
      // Dutch postcode ranges per province (accurate mapping)
      if (postcodeNum >= 1000 && postcodeNum <= 1299) return 'Noord-Holland'; // Amsterdam
      if (postcodeNum >= 1300 && postcodeNum <= 1379) return 'Flevoland'; // Almere
      if (postcodeNum >= 1380 && postcodeNum <= 1384) return 'Noord-Holland';
      if (postcodeNum >= 1385 && postcodeNum <= 1424) return 'Noord-Holland';
      if (postcodeNum >= 1425 && postcodeNum <= 1949) return 'Noord-Holland';
      if (postcodeNum >= 1950 && postcodeNum <= 1999) return 'Noord-Holland';
      if (postcodeNum >= 2000 && postcodeNum <= 2199) return 'Zuid-Holland'; // Leiden area
      if (postcodeNum >= 2200 && postcodeNum <= 2299) return 'Zuid-Holland';
      if (postcodeNum >= 2300 && postcodeNum <= 2399) return 'Zuid-Holland'; // The Hague
      if (postcodeNum >= 2400 && postcodeNum <= 2699) return 'Zuid-Holland';
      if (postcodeNum >= 2700 && postcodeNum <= 2799) return 'Zuid-Holland'; // Zoetermeer
      if (postcodeNum >= 2800 && postcodeNum <= 2999) return 'Zuid-Holland'; // Gouda
      if (postcodeNum >= 3000 && postcodeNum <= 3099) return 'Zuid-Holland'; // Rotterdam
      if (postcodeNum >= 3100 && postcodeNum <= 3399) return 'Zuid-Holland';
      if (postcodeNum >= 3400 && postcodeNum <= 3439) return 'Utrecht';
      if (postcodeNum >= 3440 && postcodeNum <= 3449) return 'Zuid-Holland';
      if (postcodeNum >= 3450 && postcodeNum <= 3499) return 'Utrecht';
      if (postcodeNum >= 3500 && postcodeNum <= 3599) return 'Utrecht'; // Utrecht city
      if (postcodeNum >= 3600 && postcodeNum <= 3799) return 'Utrecht';
      if (postcodeNum >= 3800 && postcodeNum <= 3899) return 'Utrecht'; // Amersfoort
      if (postcodeNum >= 3900 && postcodeNum <= 3999) return 'Gelderland'; // Veenendaal
      if (postcodeNum >= 4000 && postcodeNum <= 4199) return 'Gelderland';
      if (postcodeNum >= 4200 && postcodeNum <= 4299) return 'Zuid-Holland'; // Gorinchem area
      if (postcodeNum >= 4300 && postcodeNum <= 4599) return 'Zeeland';
      if (postcodeNum >= 4600 && postcodeNum <= 4699) return 'Noord-Brabant'; // Bergen op Zoom
      if (postcodeNum >= 4700 && postcodeNum <= 4799) return 'Noord-Brabant'; // Roosendaal
      if (postcodeNum >= 4800 && postcodeNum <= 4899) return 'Noord-Brabant'; // Breda
      if (postcodeNum >= 4900 && postcodeNum <= 4999) return 'Noord-Brabant';
      if (postcodeNum >= 5000 && postcodeNum <= 5099) return 'Noord-Brabant'; // Tilburg
      if (postcodeNum >= 5100 && postcodeNum <= 5299) return 'Noord-Brabant'; // 's-Hertogenbosch
      if (postcodeNum >= 5300 && postcodeNum <= 5599) return 'Noord-Brabant';
      if (postcodeNum >= 5600 && postcodeNum <= 5699) return 'Noord-Brabant'; // Eindhoven
      if (postcodeNum >= 5700 && postcodeNum <= 5799) return 'Noord-Brabant'; // Helmond
      if (postcodeNum >= 5800 && postcodeNum <= 5899) return 'Limburg';
      if (postcodeNum >= 5900 && postcodeNum <= 5999) return 'Limburg'; // Venlo
      if (postcodeNum >= 6000 && postcodeNum <= 6199) return 'Limburg';
      if (postcodeNum >= 6200 && postcodeNum <= 6299) return 'Limburg'; // Maastricht
      if (postcodeNum >= 6300 && postcodeNum <= 6499) return 'Limburg'; // Heerlen
      if (postcodeNum >= 6500 && postcodeNum <= 6599) return 'Limburg';
      if (postcodeNum >= 6600 && postcodeNum <= 6699) return 'Gelderland';
      if (postcodeNum >= 6700 && postcodeNum <= 6799) return 'Gelderland'; // Wageningen
      if (postcodeNum >= 6800 && postcodeNum <= 6899) return 'Gelderland'; // Arnhem
      if (postcodeNum >= 6900 && postcodeNum <= 6999) return 'Gelderland';
      if (postcodeNum >= 7000 && postcodeNum <= 7099) return 'Gelderland'; // Doetinchem
      if (postcodeNum >= 7100 && postcodeNum <= 7199) return 'Gelderland';
      if (postcodeNum >= 7200 && postcodeNum <= 7299) return 'Gelderland'; // Zutphen
      if (postcodeNum >= 7300 && postcodeNum <= 7399) return 'Gelderland'; // Apeldoorn
      if (postcodeNum >= 7400 && postcodeNum <= 7499) return 'Overijssel'; // Deventer
      if (postcodeNum >= 7500 && postcodeNum <= 7599) return 'Overijssel'; // Enschede
      if (postcodeNum >= 7600 && postcodeNum <= 7699) return 'Overijssel'; // Almelo
      if (postcodeNum >= 7700 && postcodeNum <= 7799) return 'Overijssel';
      if (postcodeNum >= 7800 && postcodeNum <= 7899) return 'Drenthe'; // Emmen
      if (postcodeNum >= 7900 && postcodeNum <= 7999) return 'Overijssel';
      if (postcodeNum >= 8000 && postcodeNum <= 8099) return 'Overijssel'; // Zwolle
      if (postcodeNum >= 8100 && postcodeNum <= 8199) return 'Flevoland'; // Lelystad
      if (postcodeNum >= 8200 && postcodeNum <= 8299) return 'Flevoland';
      if (postcodeNum >= 8300 && postcodeNum <= 8399) return 'Flevoland'; // Emmeloord
      if (postcodeNum >= 8400 && postcodeNum <= 8499) return 'Friesland';
      if (postcodeNum >= 8500 && postcodeNum <= 8599) return 'Friesland'; // Joure
      if (postcodeNum >= 8600 && postcodeNum <= 8699) return 'Friesland'; // Sneek
      if (postcodeNum >= 8700 && postcodeNum <= 8799) return 'Friesland';
      if (postcodeNum >= 8800 && postcodeNum <= 8899) return 'Friesland';
      if (postcodeNum >= 8900 && postcodeNum <= 8999) return 'Friesland'; // Leeuwarden
      if (postcodeNum >= 9000 && postcodeNum <= 9099) return 'Groningen'; // Groningen city
      if (postcodeNum >= 9100 && postcodeNum <= 9199) return 'Friesland'; // Dokkum
      if (postcodeNum >= 9200 && postcodeNum <= 9299) return 'Friesland'; // Drachten
      if (postcodeNum >= 9300 && postcodeNum <= 9399) return 'Drenthe'; // Roden
      if (postcodeNum >= 9400 && postcodeNum <= 9499) return 'Drenthe'; // Assen
      if (postcodeNum >= 9500 && postcodeNum <= 9599) return 'Groningen';
      if (postcodeNum >= 9600 && postcodeNum <= 9699) return 'Groningen';
      if (postcodeNum >= 9700 && postcodeNum <= 9799) return 'Groningen';
      if (postcodeNum >= 9800 && postcodeNum <= 9899) return 'Groningen';
      if (postcodeNum >= 9900 && postcodeNum <= 9999) return 'Groningen';
      
      return null;
    }

    // ================================
    // Value Calculation
    // ================================
    function calculateValueFromCurrentData() {
      const postcode = (postcodeInput?.value || '').replace(/\s/g, '').toUpperCase();
      const postcodeRegex = /^[1-9][0-9]{3}[A-Z]{2}$/;
      
      // Only calculate if we have a valid postcode
      if (!postcodeRegex.test(postcode)) {
        return;
      }

      // Get extension area
      const depth = parseFloat(depthInput?.value) || 0;
      const length = parseFloat(lengthInput?.value) || 0;
      const extensionArea = (depth * length) / 10000; // Convert cm² to m²

      // Use province from API response (more accurate) or fall back to postcode mapping
      const province = currentProvince || getProvinceFromPostcode(postcode);
      const m2Price = province && provinceM2Prices[province] 
        ? provinceM2Prices[province] 
        : defaultM2Price;

      // Calculate value appreciation
      const valueIncrease = Math.round(extensionArea * m2Price);

      // Display result
      if (valueDisplay) {
        valueDisplay.innerHTML = `€${valueIncrease.toLocaleString('nl-NL')}<sup>*</sup>`;
      }
    }

    // ================================
    // Address Lookup via PDOK API
    // ================================
    async function lookupAddress() {
      const postcode = (postcodeInput?.value || '').replace(/\s/g, '').toUpperCase();
      const housenumber = (housenumberInput?.value || '').trim();
      const addition = (additionInput?.value || '').trim();

      // Validate inputs
      if (!postcode || postcode.length < 6 || !housenumber) {
        if (addressDisplay) addressDisplay.textContent = 'Straatnaam, Plaats';
        if (valueDisplay) valueDisplay.innerHTML = '€0<sup>?</sup>';
        return;
      }

      // Validate postcode format (1234AB pattern)
      const postcodeRegex = /^[1-9][0-9]{3}[A-Z]{2}$/;
      if (!postcodeRegex.test(postcode)) {
        if (addressDisplay) addressDisplay.textContent = 'Ongeldige postcode';
        if (valueDisplay) valueDisplay.innerHTML = '€0<sup>?</sup>';
        return;
      }

      try {
        // Use PDOK API for address lookup
        const searchQuery = `${postcode} ${housenumber}${addition ? ' ' + addition : ''}`;
        const apiUrl = `https://api.pdok.nl/bzk/locatieserver/search/v3_1/free?q=${encodeURIComponent(searchQuery)}&rows=1&fq=type:adres`;

        const response = await fetch(apiUrl);

        if (!response.ok) {
          throw new Error('API request failed');
        }

        const data = await response.json();

        if (data.response && data.response.docs && data.response.docs.length > 0) {
          const address = data.response.docs[0];
          const street = address.straatnaam || '';
          const city = address.woonplaatsnaam || '';

          // Store province from API response (more accurate than postcode mapping)
          currentProvince = address.provincienaam || null;

          // Update address display
          if (addressDisplay) {
            addressDisplay.textContent = `${street}, ${city}`;
          }

          // Calculate and display value appreciation
          calculateValueFromCurrentData();
        } else {
          // No address found, but still try to calculate using postcode fallback
          currentProvince = getProvinceFromPostcode(postcode);
          if (addressDisplay) addressDisplay.textContent = 'Adres niet gevonden';
          
          // If we got a province from postcode, still calculate value
          if (currentProvince) {
            calculateValueFromCurrentData();
          } else {
            if (valueDisplay) valueDisplay.innerHTML = '€0<sup>?</sup>';
          }
        }
      } catch (error) {
        console.error('Address lookup error:', error);
        // On error, try to calculate using postcode fallback
        currentProvince = getProvinceFromPostcode(postcode);
        if (addressDisplay) addressDisplay.textContent = 'Adres niet gevonden';
        
        // If we got a province from postcode, still calculate value
        if (currentProvince) {
          calculateValueFromCurrentData();
        } else {
          if (valueDisplay) valueDisplay.innerHTML = '€0<sup>?</sup>';
        }
      }
    }

    // ================================
    // Debounced Input Handler
    // ================================
    function handleAddressInput() {
      // Clear existing timer
      if (debounceTimer) {
        clearTimeout(debounceTimer);
      }
      // Set new timer for debounced API call
      debounceTimer = setTimeout(() => {
        lookupAddress();
      }, 500);
    }

    // ================================
    // Event Bindings
    // ================================
    if (depthInput) {
      depthInput.addEventListener('input', calculateSize);
    }
    if (lengthInput) {
      lengthInput.addEventListener('input', calculateSize);
    }
    if (postcodeInput) {
      postcodeInput.addEventListener('input', handleAddressInput);
    }
    if (housenumberInput) {
      housenumberInput.addEventListener('input', handleAddressInput);
    }
    if (additionInput) {
      additionInput.addEventListener('input', handleAddressInput);
    }

    // Initialize calculation
    calculateSize();

    // ================================
    // Public API
    // ================================
    window.ZSCalcSize = {
      calculateSize,
      lookupAddress,
      calculateValue: calculateValueFromCurrentData,
      getValues: function() {
        return {
          postcode: postcodeInput?.value || '',
          housenumber: housenumberInput?.value || '',
          addition: additionInput?.value || '',
          depth: parseFloat(depthInput?.value) || 0,
          length: parseFloat(lengthInput?.value) || 0,
          sizeM2: parseFloat(sizeResult?.textContent) || 0
        };
      }
    };
  })();
</script>